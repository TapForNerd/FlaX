{% extends "base.html" %}

{% block title %}X Posts{% endblock %}

{% block content %}

<style>
  .x-card {
    border: 0;
    border-radius: 1rem;
    position: relative;
    overflow: hidden;
  }
  .x-muted { color: rgba(0,0,0,.60); }
  .x-pill {
    border: 1px solid rgba(0,0,0,.10);
    border-radius: 999px;
    padding: .35rem .65rem;
    font-size: .85rem;
    background: #fff;
  }
  .x-section-title {
    font-weight: 600;
    font-size: .95rem;
    margin-bottom: .35rem;
  }
  pre.x-pre {
    max-height: 420px;
    overflow: auto;
    background: #0b1020;
    color: #d7e2ff;
    border-radius: .75rem;
    padding: 1rem;
    font-size: .85rem;
    margin: 0;
  }
</style>

<div class="container-fluid py-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;">
        {% for category, message in messages %}
          <div class="toast text-bg-{{ category }} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">{{ message }}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="d-flex align-items-end justify-content-between mb-3">
    <div>
      <h3 class="mb-1">X Posts Studio</h3>
      <div class="x-muted">Create, edit, and explore Posts with every supported option.</div>
    </div>
    <span class="x-pill">Read + Write</span>
  </div>

  <div class="row g-4">
    <div class="col-xl-7">
      <div class="card x-card shadow-sm mb-4">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="mb-1">Compose or edit a Post</h5>
              <div class="x-muted small">Use the same form to create a new Post or edit an existing one.</div>
            </div>
            <span class="badge text-bg-light border">POST /2/tweets</span>
          </div>

          {% if known_limit %}
            <div class="alert alert-warning d-flex align-items-start gap-2 mb-3">
              <div class="fw-semibold">Known limitation:</div>
              <div class="flex-grow-1">{{ known_limit }}</div>
            </div>
          {% endif %}
          {% if error %}
            <div class="alert alert-warning d-flex align-items-start gap-2 mb-3">
              <div class="fw-semibold">Heads up:</div>
              <div class="flex-grow-1">{{ error }}</div>
            </div>
          {% endif %}

          <form method="post">
            <div class="mb-3">
              <label class="form-label small x-muted mb-1">Post text</label>
              <textarea name="post_text" class="form-control" rows="4" placeholder="Write something...">{{ post_text or '' }}</textarea>
              <div class="form-text">Long-form notes are created automatically when supported by your account.</div>
            </div>

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">Quote Post ID</label>
                <input type="text" name="post_quote_tweet_id" class="form-control" value="{{ post_quote_tweet_id or '' }}" placeholder="1346889436626259968" list="postIdOptions">
                <div class="form-text">Mutually exclusive with card, poll, and media.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">Reply to Post ID</label>
                <input type="text" name="post_reply_to_id" class="form-control" value="{{ post_reply_to_id or '' }}" placeholder="1346889436626259968" list="postIdOptions">
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">Card URI</label>
                <input type="text" name="post_card_uri" class="form-control" value="{{ post_card_uri or '' }}" placeholder="card://1234">
              </div>
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">DM deep link</label>
                <input type="text" name="post_direct_message_deep_link" class="form-control" value="{{ post_direct_message_deep_link or '' }}" placeholder="https://x.com/messages/compose?...">
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">Community ID</label>
                <input type="text" name="post_community_id" class="form-control" value="{{ post_community_id or '' }}" placeholder="1146654567674912769">
              </div>
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">Geo place ID</label>
                <input type="text" name="post_geo_place_id" class="form-control" value="{{ post_geo_place_id or '' }}" placeholder="f7eb2fa2fea288b1">
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">Reply settings</label>
                <select class="form-select" name="post_reply_settings">
                  <option value="">Default</option>
                  <option value="following" {% if post_reply_settings == 'following' %}selected{% endif %}>following</option>
                  <option value="mentionedUsers" {% if post_reply_settings == 'mentionedUsers' %}selected{% endif %}>mentionedUsers</option>
                  <option value="subscribers" {% if post_reply_settings == 'subscribers' %}selected{% endif %}>subscribers</option>
                  <option value="verified" {% if post_reply_settings == 'verified' %}selected{% endif %}>verified</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">Edit previous Post ID</label>
                <input type="text" name="post_edit_previous_id" class="form-control" value="{{ post_edit_previous_id or '' }}" placeholder="1346889436626259968" list="postIdOptions">
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">Schedule time</label>
                <input type="datetime-local" name="post_schedule_time" class="form-control" value="{{ post_schedule_time or '' }}">
                <div class="form-text">Scheduling is not supported yet. Leaving it blank is recommended.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label small x-muted mb-1">Tagged user IDs (media)</label>
                <input type="text" name="post_media_tagged_user_ids" class="form-control" value="{{ post_media_tagged_user_ids or '' }}" placeholder="123,456,789">
              </div>
            </div>

            <div class="mt-3">
              <div class="x-section-title">Media attachments</div>
              <div class="row g-2">
                <div class="col-md-6">
                  <input type="text" name="post_media_ids" class="form-control" value="{{ post_media_ids or '' }}" placeholder="media_id1,media_id2">
                  <div class="form-text">Mutually exclusive with poll and card URI.</div>
                </div>
                <div class="col-md-6">
                  <select class="form-select" name="post_media_select" multiple size="3">
                    {% for upload in media_uploads %}
                      {% if upload.media_id %}
                        <option value="{{ upload.media_id }}" {% if upload.media_id in post_media_select %}selected{% endif %}>
                          {{ upload.media_id }}{% if upload.media_type %} · {{ upload.media_type }}{% endif %}
                        </option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  <div class="form-text">Select from recent uploads to attach.</div>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <div class="x-section-title">Poll options</div>
              <div class="row g-2">
                <div class="col-md-7">
                  <textarea name="post_poll_options" class="form-control" rows="2" placeholder="Option A, Option B">{{ post_poll_options or '' }}</textarea>
                  <div class="form-text">Comma or newline separated options. 2-4 options.</div>
                </div>
                <div class="col-md-5">
                  <input type="number" min="5" max="10080" name="post_poll_duration" class="form-control" value="{{ post_poll_duration or '' }}" placeholder="Duration (minutes)">
                  <select class="form-select mt-2" name="post_poll_reply_settings">
                    <option value="">Poll reply settings</option>
                    <option value="following" {% if post_poll_reply_settings == 'following' %}selected{% endif %}>following</option>
                    <option value="mentionedUsers" {% if post_poll_reply_settings == 'mentionedUsers' %}selected{% endif %}>mentionedUsers</option>
                    <option value="subscribers" {% if post_poll_reply_settings == 'subscribers' %}selected{% endif %}>subscribers</option>
                    <option value="verified" {% if post_poll_reply_settings == 'verified' %}selected{% endif %}>verified</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <div class="x-section-title">Reply metadata</div>
              <div class="row g-2">
                <div class="col-md-6">
                  <input type="text" name="post_reply_exclude_user_ids" class="form-control" value="{{ post_reply_exclude_user_ids or '' }}" placeholder="Exclude user IDs">
                </div>
                <div class="col-md-6">
                  <div class="form-check mt-1">
                    <input class="form-check-input" type="checkbox" name="post_reply_auto_metadata" id="replyAuto" {% if post_reply_auto_metadata %}checked{% endif %}>
                    <label class="form-check-label" for="replyAuto">Auto populate reply metadata</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="post_for_super_followers_only" id="superFollow" {% if post_for_super_followers_only %}checked{% endif %}>
                  <label class="form-check-label" for="superFollow">Super followers only</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="post_nullcast" id="nullcast" {% if post_nullcast %}checked{% endif %}>
                  <label class="form-check-label" for="nullcast">Nullcast (promoted only)</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="post_share_with_followers" id="shareFollowers" {% if post_share_with_followers %}checked{% endif %}>
                  <label class="form-check-label" for="shareFollowers">Share with followers</label>
                </div>
              </div>
            </div>

            <div class="d-flex align-items-center justify-content-between mt-3">
              <div class="form-text">Conflicts: card URI, poll, media, and quote cannot be combined.</div>
              <button class="btn btn-dark" type="submit" name="posts_action" value="create_post">Create or edit Post</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card x-card shadow-sm mb-4">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="mb-1">Post actions</h5>
              <div class="x-muted small">Delete, repost, unrepost, and view reposts of your account.</div>
            </div>
            <span class="badge text-bg-light border">Actions</span>
          </div>

          <div class="accordion" id="postActionsAccordion">
            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hDeletePost">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cDeletePost" aria-expanded="true" aria-controls="cDeletePost">
                  Delete a Post
                </button>
              </h2>
              <div id="cDeletePost" class="accordion-collapse collapse show" aria-labelledby="hDeletePost" data-bs-parent="#postActionsAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">Post ID</label>
                    <input type="text" name="delete_post_id" class="form-control" value="{{ delete_post_id or '' }}" placeholder="1346889436626259968" list="postIdOptions">
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Requires OAuth user context.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="delete_post">Delete Post</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hRepost">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cRepost" aria-expanded="false" aria-controls="cRepost">
                  Repost or unrepost
                </button>
              </h2>
              <div id="cRepost" class="accordion-collapse collapse" aria-labelledby="hRepost" data-bs-parent="#postActionsAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">Post ID</label>
                    <input type="text" name="repost_post_id" class="form-control" value="{{ repost_post_id or '' }}" placeholder="1346889436626259968" list="postIdOptions">
                    <div class="d-flex flex-wrap gap-2 mt-3">
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="repost_post">Repost</button>
                      <button class="btn btn-outline-danger" type="submit" name="posts_action" value="unrepost_post">Unrepost</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hRepostsOfMe">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cRepostsOfMe" aria-expanded="false" aria-controls="cRepostsOfMe">
                  Get reposts of me
                </button>
              </h2>
              <div id="cRepostsOfMe" class="accordion-collapse collapse" aria-labelledby="hRepostsOfMe" data-bs-parent="#postActionsAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <div class="row g-2">
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Max results</label>
                        <input type="number" name="reposts_max_results" class="form-control" value="{{ reposts_max_results or '' }}" min="1" max="100" placeholder="100">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Pagination token</label>
                        <input type="text" name="reposts_pagination_token" class="form-control" value="{{ reposts_pagination_token or '' }}" placeholder="Next token">
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Timeline read scope required.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="reposts_of_me">Fetch reposts</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card x-card shadow-sm mb-4">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="mb-1">Lookups and quotes</h5>
              <div class="x-muted small">Fetch single or multiple Posts, plus quote Tweets.</div>
            </div>
            <span class="badge text-bg-light border">Lookup</span>
          </div>

          <div class="accordion" id="postLookupAccordion">
            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hLookupSingle">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cLookupSingle" aria-expanded="true" aria-controls="cLookupSingle">
                  Get Post by ID or URL
                </button>
              </h2>
              <div id="cLookupSingle" class="accordion-collapse collapse show" aria-labelledby="hLookupSingle" data-bs-parent="#postLookupAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">Post ID or URL</label>
                    <input type="text" name="lookup_post_id" class="form-control" value="{{ lookup_post_id or '' }}" placeholder="https://x.com/.../status/123" list="postIdOptions">
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Bearer token or OAuth user context.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="lookup_post">Lookup Post</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hLookupMulti">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cLookupMulti" aria-expanded="false" aria-controls="cLookupMulti">
                  Get Posts by IDs
                </button>
              </h2>
              <div id="cLookupMulti" class="accordion-collapse collapse" aria-labelledby="hLookupMulti" data-bs-parent="#postLookupAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">Post IDs (comma separated)</label>
                    <textarea name="lookup_post_ids" class="form-control" rows="2" placeholder="123,456,789">{{ lookup_post_ids or '' }}</textarea>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Up to 100 IDs per request.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="lookup_posts">Lookup Posts</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hQuoteTweets">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cQuoteTweets" aria-expanded="false" aria-controls="cQuoteTweets">
                  Get quoted Posts
                </button>
              </h2>
              <div id="cQuoteTweets" class="accordion-collapse collapse" aria-labelledby="hQuoteTweets" data-bs-parent="#postLookupAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">Post ID</label>
                    <input type="text" name="quote_post_id" class="form-control" value="{{ quote_post_id or '' }}" placeholder="1346889436626259968" list="postIdOptions">
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Max results</label>
                        <input type="number" name="quote_max_results" class="form-control" min="10" max="100" value="{{ quote_max_results or '' }}" placeholder="10">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Pagination token</label>
                        <input type="text" name="quote_pagination_token" class="form-control" value="{{ quote_pagination_token or '' }}" placeholder="Next token">
                      </div>
                    </div>
                    <div class="d-flex flex-wrap gap-3 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="quote_exclude_replies" id="quoteExcludeReplies" {% if quote_exclude_replies %}checked{% endif %}>
                        <label class="form-check-label" for="quoteExcludeReplies">Exclude replies</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="quote_exclude_retweets" id="quoteExcludeRetweets" {% if quote_exclude_retweets %}checked{% endif %}>
                        <label class="form-check-label" for="quoteExcludeRetweets">Exclude retweets</label>
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Bearer token or OAuth user context.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="quote_tweets">Fetch quoted Posts</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card x-card shadow-sm mb-4">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="mb-1">Search and counts</h5>
              <div class="x-muted small">Search Posts or get counts for recent or full archive.</div>
            </div>
            <span class="badge text-bg-light border">Search</span>
          </div>

          <div class="accordion" id="postSearchAccordion">
            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hSearchRecent">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cSearchRecent" aria-expanded="true" aria-controls="cSearchRecent">
                  Search recent Posts
                </button>
              </h2>
              <div id="cSearchRecent" class="accordion-collapse collapse show" aria-labelledby="hSearchRecent" data-bs-parent="#postSearchAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">Query</label>
                    <input type="text" name="search_recent_query" class="form-control" value="{{ search_recent_query or '' }}" placeholder="from:XDevelopers has:media -is:retweet">
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Start time</label>
                        <input type="text" name="search_recent_start_time" class="form-control" value="{{ search_recent_start_time or '' }}" placeholder="2021-02-01T18:40:40Z">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">End time</label>
                        <input type="text" name="search_recent_end_time" class="form-control" value="{{ search_recent_end_time or '' }}" placeholder="2021-02-02T18:40:40Z">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Since ID</label>
                        <input type="text" name="search_recent_since_id" class="form-control" value="{{ search_recent_since_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Until ID</label>
                        <input type="text" name="search_recent_until_id" class="form-control" value="{{ search_recent_until_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Max results</label>
                        <input type="number" name="search_recent_max_results" class="form-control" min="10" max="100" value="{{ search_recent_max_results or '' }}" placeholder="10">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Next token</label>
                        <input type="text" name="search_recent_next_token" class="form-control" value="{{ search_recent_next_token or '' }}" placeholder="Next token">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Pagination token</label>
                        <input type="text" name="search_recent_pagination_token" class="form-control" value="{{ search_recent_pagination_token or '' }}" placeholder="Next token">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Sort order</label>
                        <select class="form-select" name="search_recent_sort_order">
                          <option value="">Default</option>
                          <option value="recency" {% if search_recent_sort_order == 'recency' %}selected{% endif %}>recency</option>
                          <option value="relevancy" {% if search_recent_sort_order == 'relevancy' %}selected{% endif %}>relevancy</option>
                        </select>
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Requires tweet.read scope for user token flows.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="search_recent">Search recent</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hSearchAll">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cSearchAll" aria-expanded="false" aria-controls="cSearchAll">
                  Search full archive
                </button>
              </h2>
              <div id="cSearchAll" class="accordion-collapse collapse" aria-labelledby="hSearchAll" data-bs-parent="#postSearchAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">Query</label>
                    <input type="text" name="search_all_query" class="form-control" value="{{ search_all_query or '' }}" placeholder="from:XDevelopers has:media -is:retweet">
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Start time</label>
                        <input type="text" name="search_all_start_time" class="form-control" value="{{ search_all_start_time or '' }}" placeholder="2021-02-01T18:40:40Z">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">End time</label>
                        <input type="text" name="search_all_end_time" class="form-control" value="{{ search_all_end_time or '' }}" placeholder="2021-02-02T18:40:40Z">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Since ID</label>
                        <input type="text" name="search_all_since_id" class="form-control" value="{{ search_all_since_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Until ID</label>
                        <input type="text" name="search_all_until_id" class="form-control" value="{{ search_all_until_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Max results</label>
                        <input type="number" name="search_all_max_results" class="form-control" min="10" max="500" value="{{ search_all_max_results or '' }}" placeholder="10">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Next token</label>
                        <input type="text" name="search_all_next_token" class="form-control" value="{{ search_all_next_token or '' }}" placeholder="Next token">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Pagination token</label>
                        <input type="text" name="search_all_pagination_token" class="form-control" value="{{ search_all_pagination_token or '' }}" placeholder="Next token">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Sort order</label>
                        <select class="form-select" name="search_all_sort_order">
                          <option value="">Default</option>
                          <option value="recency" {% if search_all_sort_order == 'recency' %}selected{% endif %}>recency</option>
                          <option value="relevancy" {% if search_all_sort_order == 'relevancy' %}selected{% endif %}>relevancy</option>
                        </select>
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Requires elevated access for full-archive search.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="search_all">Search full archive</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hCountsRecent">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cCountsRecent" aria-expanded="false" aria-controls="cCountsRecent">
                  Recent Post counts
                </button>
              </h2>
              <div id="cCountsRecent" class="accordion-collapse collapse" aria-labelledby="hCountsRecent" data-bs-parent="#postSearchAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">Query</label>
                    <input type="text" name="counts_recent_query" class="form-control" value="{{ counts_recent_query or '' }}" placeholder="from:XDevelopers">
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Start time</label>
                        <input type="text" name="counts_recent_start_time" class="form-control" value="{{ counts_recent_start_time or '' }}" placeholder="2021-02-01T18:40:40Z">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">End time</label>
                        <input type="text" name="counts_recent_end_time" class="form-control" value="{{ counts_recent_end_time or '' }}" placeholder="2021-02-02T18:40:40Z">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Since ID</label>
                        <input type="text" name="counts_recent_since_id" class="form-control" value="{{ counts_recent_since_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Until ID</label>
                        <input type="text" name="counts_recent_until_id" class="form-control" value="{{ counts_recent_until_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Granularity</label>
                        <select class="form-select" name="counts_recent_granularity">
                          <option value="">Default</option>
                          <option value="minute" {% if counts_recent_granularity == 'minute' %}selected{% endif %}>minute</option>
                          <option value="hour" {% if counts_recent_granularity == 'hour' %}selected{% endif %}>hour</option>
                          <option value="day" {% if counts_recent_granularity == 'day' %}selected{% endif %}>day</option>
                        </select>
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Next token</label>
                        <input type="text" name="counts_recent_next_token" class="form-control" value="{{ counts_recent_next_token or '' }}" placeholder="Next token">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Pagination token</label>
                        <input type="text" name="counts_recent_pagination_token" class="form-control" value="{{ counts_recent_pagination_token or '' }}" placeholder="Next token">
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Counts do not return Post content.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="counts_recent">Fetch recent counts</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hCountsAll">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cCountsAll" aria-expanded="false" aria-controls="cCountsAll">
                  Full-archive Post counts
                </button>
              </h2>
              <div id="cCountsAll" class="accordion-collapse collapse" aria-labelledby="hCountsAll" data-bs-parent="#postSearchAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">Query</label>
                    <input type="text" name="counts_all_query" class="form-control" value="{{ counts_all_query or '' }}" placeholder="from:XDevelopers">
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Start time</label>
                        <input type="text" name="counts_all_start_time" class="form-control" value="{{ counts_all_start_time or '' }}" placeholder="2021-02-01T18:40:40Z">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">End time</label>
                        <input type="text" name="counts_all_end_time" class="form-control" value="{{ counts_all_end_time or '' }}" placeholder="2021-02-02T18:40:40Z">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Since ID</label>
                        <input type="text" name="counts_all_since_id" class="form-control" value="{{ counts_all_since_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Until ID</label>
                        <input type="text" name="counts_all_until_id" class="form-control" value="{{ counts_all_until_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Granularity</label>
                        <select class="form-select" name="counts_all_granularity">
                          <option value="">Default</option>
                          <option value="minute" {% if counts_all_granularity == 'minute' %}selected{% endif %}>minute</option>
                          <option value="hour" {% if counts_all_granularity == 'hour' %}selected{% endif %}>hour</option>
                          <option value="day" {% if counts_all_granularity == 'day' %}selected{% endif %}>day</option>
                        </select>
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Next token</label>
                        <input type="text" name="counts_all_next_token" class="form-control" value="{{ counts_all_next_token or '' }}" placeholder="Next token">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small x-muted mb-1">Pagination token</label>
                        <input type="text" name="counts_all_pagination_token" class="form-control" value="{{ counts_all_pagination_token or '' }}" placeholder="Next token">
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Enterprise access required.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="counts_all">Fetch full-archive counts</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card x-card shadow-sm">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="mb-1">Timelines and mentions</h5>
              <div class="x-muted small">Browse a user timeline, mentions, or your home feed.</div>
            </div>
            <span class="badge text-bg-light border">Timeline</span>
          </div>

          <div class="accordion" id="postTimelineAccordion">
            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hUserTimeline">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cUserTimeline" aria-expanded="true" aria-controls="cUserTimeline">
                  User Post timeline
                </button>
              </h2>
              <div id="cUserTimeline" class="accordion-collapse collapse show" aria-labelledby="hUserTimeline" data-bs-parent="#postTimelineAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">User ID or username</label>
                    <input type="text" name="timeline_user_identifier" class="form-control" value="{{ timeline_user_identifier or '' }}" placeholder="@xdevelopers" list="userIdOptions">
                    <div class="mt-2">
                      <label class="form-label small x-muted mb-1">Or pick an existing user</label>
                      <select class="form-select" name="timeline_user_select">
                        <option value="">Select from saved users</option>
                        {% for user in existing_users %}
                          <option value="{{ user.id }}" {% if timeline_user_select == (user.id | string) %}selected{% endif %}>
                            @{{ user.username }}{% if user.name %} · {{ user.name }}{% endif %} ({{ user.id }})
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Max results</label>
                        <input type="number" name="timeline_max_results" class="form-control" min="5" max="100" value="{{ timeline_max_results or '' }}" placeholder="10">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Pagination token</label>
                        <input type="text" name="timeline_pagination_token" class="form-control" value="{{ timeline_pagination_token or '' }}" placeholder="Next token">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Since ID</label>
                        <input type="text" name="timeline_since_id" class="form-control" value="{{ timeline_since_id or '' }}" placeholder="1346889436626259968">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Until ID</label>
                        <input type="text" name="timeline_until_id" class="form-control" value="{{ timeline_until_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Start time</label>
                        <input type="text" name="timeline_start_time" class="form-control" value="{{ timeline_start_time or '' }}" placeholder="2021-02-01T18:40:40Z">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">End time</label>
                        <input type="text" name="timeline_end_time" class="form-control" value="{{ timeline_end_time or '' }}" placeholder="2021-02-02T18:40:40Z">
                      </div>
                    </div>
                    <div class="d-flex flex-wrap gap-3 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="timeline_exclude_replies" id="timelineExcludeReplies" {% if timeline_exclude_replies %}checked{% endif %}>
                        <label class="form-check-label" for="timelineExcludeReplies">Exclude replies</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="timeline_exclude_retweets" id="timelineExcludeRetweets" {% if timeline_exclude_retweets %}checked{% endif %}>
                        <label class="form-check-label" for="timelineExcludeRetweets">Exclude retweets</label>
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">User token recommended for protected timelines.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="timeline_posts">Fetch user timeline</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hMentions">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cMentions" aria-expanded="false" aria-controls="cMentions">
                  User mentions
                </button>
              </h2>
              <div id="cMentions" class="accordion-collapse collapse" aria-labelledby="hMentions" data-bs-parent="#postTimelineAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <label class="form-label small x-muted mb-1">User ID or username</label>
                    <input type="text" name="mentions_user_identifier" class="form-control" value="{{ mentions_user_identifier or '' }}" placeholder="@xdevelopers" list="userIdOptions">
                    <div class="mt-2">
                      <label class="form-label small x-muted mb-1">Or pick an existing user</label>
                      <select class="form-select" name="mentions_user_select">
                        <option value="">Select from saved users</option>
                        {% for user in existing_users %}
                          <option value="{{ user.id }}" {% if mentions_user_select == (user.id | string) %}selected{% endif %}>
                            @{{ user.username }}{% if user.name %} · {{ user.name }}{% endif %} ({{ user.id }})
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Max results</label>
                        <input type="number" name="mentions_max_results" class="form-control" min="5" max="100" value="{{ mentions_max_results or '' }}" placeholder="10">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Pagination token</label>
                        <input type="text" name="mentions_pagination_token" class="form-control" value="{{ mentions_pagination_token or '' }}" placeholder="Next token">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Since ID</label>
                        <input type="text" name="mentions_since_id" class="form-control" value="{{ mentions_since_id or '' }}" placeholder="1346889436626259968">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Until ID</label>
                        <input type="text" name="mentions_until_id" class="form-control" value="{{ mentions_until_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Start time</label>
                        <input type="text" name="mentions_start_time" class="form-control" value="{{ mentions_start_time or '' }}" placeholder="2021-02-01T18:40:40Z">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">End time</label>
                        <input type="text" name="mentions_end_time" class="form-control" value="{{ mentions_end_time or '' }}" placeholder="2021-02-02T18:40:40Z">
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Mention lookups include replies.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="mentions_posts">Fetch mentions</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <div class="accordion-item border-0">
              <h2 class="accordion-header" id="hHomeTimeline">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cHomeTimeline" aria-expanded="false" aria-controls="cHomeTimeline">
                  Home timeline
                </button>
              </h2>
              <div id="cHomeTimeline" class="accordion-collapse collapse" aria-labelledby="hHomeTimeline" data-bs-parent="#postTimelineAccordion">
                <div class="accordion-body pt-3">
                  <form method="post">
                    <div class="row g-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Max results</label>
                        <input type="number" name="home_max_results" class="form-control" min="1" max="100" value="{{ home_max_results or '' }}" placeholder="10">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Pagination token</label>
                        <input type="text" name="home_pagination_token" class="form-control" value="{{ home_pagination_token or '' }}" placeholder="Next token">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Since ID</label>
                        <input type="text" name="home_since_id" class="form-control" value="{{ home_since_id or '' }}" placeholder="1346889436626259968">
                      </div>
                    </div>
                    <div class="row g-2 mt-2">
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Until ID</label>
                        <input type="text" name="home_until_id" class="form-control" value="{{ home_until_id or '' }}" placeholder="1346889436626259968">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">Start time</label>
                        <input type="text" name="home_start_time" class="form-control" value="{{ home_start_time or '' }}" placeholder="2021-02-01T18:40:40Z">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small x-muted mb-1">End time</label>
                        <input type="text" name="home_end_time" class="form-control" value="{{ home_end_time or '' }}" placeholder="2021-02-02T18:40:40Z">
                      </div>
                    </div>
                    <div class="d-flex flex-wrap gap-3 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="home_exclude_replies" id="homeExcludeReplies" {% if home_exclude_replies %}checked{% endif %}>
                        <label class="form-check-label" for="homeExcludeReplies">Exclude replies</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="home_exclude_retweets" id="homeExcludeRetweets" {% if home_exclude_retweets %}checked{% endif %}>
                        <label class="form-check-label" for="homeExcludeRetweets">Exclude retweets</label>
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between mt-3">
                      <div class="form-text">Requires OAuth user context.</div>
                      <button class="btn btn-outline-dark" type="submit" name="posts_action" value="home_timeline">Fetch home timeline</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-5">
      <div class="card x-card shadow-sm mb-4">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="mb-1">Latest response</h5>
              <div class="x-muted small">Preview the most recent X API response.</div>
            </div>
            <span class="badge text-bg-light border">Response</span>
          </div>

          {% if result %}
            <div class="row g-2">
              <div class="col-12">
                <button
                  class="btn btn-link text-decoration-none p-0"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#rawPostResponse"
                  aria-expanded="true"
                  aria-controls="rawPostResponse"
                >
                  View raw response
                </button>
              </div>
              <div class="col-12">
                <div id="rawPostResponse" class="collapse show mt-2">
                  <pre class="x-pre">{{ result | tojson(indent=2) }}</pre>
                </div>
              </div>
            </div>
          {% else %}
            <div class="x-muted">Run an action to see results here.</div>
          {% endif %}

          {% if curl_preview %}
            <div class="row g-2 mt-3">
              <div class="col-12 d-flex align-items-center justify-content-between">
                <button
                  class="btn btn-link text-decoration-none p-0"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#curlPreview"
                  aria-expanded="false"
                  aria-controls="curlPreview"
                >
                  View sanitized curl command
                </button>
                <button
                  class="btn btn-sm btn-outline-dark"
                  type="button"
                  data-copy-target="#curlPreviewBox"
                  onclick="
                    const el = document.querySelector(this.getAttribute('data-copy-target'));
                    if (!el) return;
                    const text = el.textContent || '';
                    navigator.clipboard.writeText(text);
                    const original = this.textContent;
                    this.textContent = 'Copied!';
                    setTimeout(() => this.textContent = original, 1200);
                  "
                >
                  Copy curl
                </button>
              </div>
              <div class="col-12">
                <div id="curlPreview" class="collapse mt-2">
                  <textarea
                    id="curlPreviewBox"
                    class="form-control font-monospace"
                    rows="6"
                    style="width: 100%; resize: vertical;"
                    readonly
                  >{{ curl_preview }}</textarea>
                  <div class="form-text">Sanitized curl is safe to share.</div>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="card x-card shadow-sm">
        <div class="card-body p-3 p-md-4">
          <h5 class="mb-2">Field reference</h5>
          <div class="x-muted small mb-3">These are the available fields if you expand responses manually.</div>

          <div class="mb-3">
            <div class="x-section-title">Tweet fields</div>
            <div class="d-flex flex-wrap gap-2">
              {% for field in tweet_fields %}
                <span class="x-pill">{{ field }}</span>
              {% endfor %}
            </div>
          </div>

          <div class="mb-3">
            <div class="x-section-title">User fields</div>
            <div class="d-flex flex-wrap gap-2">
              {% for field in user_fields %}
                <span class="x-pill">{{ field }}</span>
              {% endfor %}
            </div>
          </div>

          <div class="mb-3">
            <div class="x-section-title">Media fields</div>
            <div class="d-flex flex-wrap gap-2">
              {% for field in media_fields %}
                <span class="x-pill">{{ field }}</span>
              {% endfor %}
            </div>
          </div>

          <div class="mb-3">
            <div class="x-section-title">Poll fields</div>
            <div class="d-flex flex-wrap gap-2">
              {% for field in poll_fields %}
                <span class="x-pill">{{ field }}</span>
              {% endfor %}
            </div>
          </div>

          <div class="mb-3">
            <div class="x-section-title">Place fields</div>
            <div class="d-flex flex-wrap gap-2">
              {% for field in place_fields %}
                <span class="x-pill">{{ field }}</span>
              {% endfor %}
            </div>
          </div>

          <div>
            <div class="x-section-title">Search count fields</div>
            <div class="d-flex flex-wrap gap-2">
              {% for field in search_count_fields %}
                <span class="x-pill">{{ field }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<datalist id="postIdOptions">
  {% for post in existing_posts %}
    <option value="{{ post.id }}">{{ post.text | truncate(42, True) }}</option>
  {% endfor %}
</datalist>

<datalist id="userIdOptions">
  {% for user in existing_users %}
    <option value="{{ user.id }}">@{{ user.username }}{% if user.name %} ({{ user.name }}){% endif %}</option>
  {% endfor %}
</datalist>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toastElList = [].slice.call(document.querySelectorAll('.toast'));
    toastElList.map((toastEl) => new bootstrap.Toast(toastEl).show());
  });
</script>

{% endblock %}
